name: Update Rolling nightlies artifacts

on:
  workflow_dispatch:
  schedule:
    # Runs at the start of every hour from 4 AM to 12 PM UTC
    - cron: '0 4-12 * * *'
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions: {}
env: 
  TAG: "release-rolling-nightlies"
  GH_REPO: ${{ github.repository }} 

jobs:
  verify-release-nightlies:
    name: Validate conditions for nightlies run
    if: github.repository == 'ros2/ros2'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      should_update: ${{ steps.verify-age.outputs.should_update }}
      artifact_urls: ${{ steps.verification.outputs.urls }}
    steps:
        # Early exit if artifacts have been updated already by a previous run. 
      - name: Verify age of artifacts
        id: verify-age
        shell: bash
        run: | 
          # Default behavior is should update unless a condition fails.
          echo "should_update=true" >> "$GITHUB_OUTPUT"

          # For the first run, avoid checking conditions since no release exists.
          if ! gh release view  --repo "$GH_REPO" "$TAG" >/dev/null 2>&1; then
            exit 0
          fi          

          THRESHOLD=$(date -d "yesterday 23:59" +%s)

          echo "Checking assets against threshold: $(date -d @$THRESHOLD)"
          ARTIFACTS=$(gh release view --repo "$GH_REPO" "$TAG" --json assets --template '{{range .assets}}{{.name}} {{.updatedAt}}{{"\n"}}{{end}}')
          
          if [ -z "$ARTIFACTS" ]; then
            echo "‚ö†Ô∏è No artifacts found! Proceeding with update."
            exit 0                                                    
          fi

          while read -r NAME TIME; do
            # Convert ISO 8601 (2026-01-08T...) to Unix seconds
            ASSET_TS=$(date -d "$TIME" +%s)

            if [ "$ASSET_TS" -gt "$THRESHOLD" ]; then
              echo "‚úÖ Artifact $NAME was updated recently (at $TIME). Skipping release."
              echo "should_update=false" >> "$GITHUB_OUTPUT"
              break
            fi
          done <<< "$ARTIFACTS"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Verify that all nightlies have passed and have been built in the last 24 hours
      - name: Verify conditions for update of artifacts
        id: verification
        shell: bash
        if: steps.verify-age.outputs.should_update == 'true'
        run: |
          echo "Verifying conditions for nightlies update";

          touch artifacts_urls.txt
          THRESHOLD=$(($(date +%s) - 86400))000;

          # curl needs --globoff to avoid having to escape all brackets in the url
          
          JOBS_STATUS=$(curl  -H "Authorization: Bearer $GH_TOKEN" --silent --globoff 'https://ci.ros2.org/api/xml?tree=jobs[name,lastBuild[number,timestamp,result,artifacts[relativePath],actions[parameters[name,value]]]]&xpath=/hudson/job[(name="packaging_linux"+or+name="packaging_windows"+or+name="packaging_linux-rhel"+or+name="packaging_linux-aarch64")+and+lastBuild/action/parameter[name="CI_ROS_DISTRO"+and+value="rolling"]]&wrapper=nightlies')
          # the XML returned have a <nightlies /> tag that needs to be cleaned to be able to split each job into a new line

          JOBS=$(echo "$JOBS_STATUS" |sed 's|<nightlies[^>]*>||g; s|</nightlies>||g' | sed 's|</job>|</job>\n|g' | sed '/^$/d')
  
          while read -r JOB_BLOCK; do

            NAME=$(echo "$JOB_BLOCK" | cut -d'>' -f3 | cut -d'<' -f1)
            BUILD=$(echo "$JOB_BLOCK" | sed -n 's|.*<number>\([^<]*\)</number>.*|\1|p')
            RESULT=$(echo "$JOB_BLOCK" | sed -n 's|.*<result>\([^<]*\)</result>.*|\1|p')
            TS=$(echo "$JOB_BLOCK" | sed -n 's|.*<timestamp>\([^<]*\)</timestamp>.*|\1|p')
            REL_PATH=$(echo "$JOB_BLOCK" | sed -n 's|.*<relativePath>\([^<]*\)</relativePath>.*|\1|p')
            
            echo "Checking Job: $NAME..."

            : # If job is still running then it's not possible to update
            if [ -z "$RESULT" ]; then
              echo "‚òÅÔ∏è Job $NAME is currently in progress or has no result."
              exit 1
            fi

            : # If the a job failed then the update should not happen to keep synchrony between os.
            if [ "$RESULT" = "FAILURE" ]; then
              echo "üåßÔ∏è Job $NAME failed with result: $RESULT"
              exit 1
            fi

            : # If the job is older than T-24 then the nightly set has not completed fully yet. 
            if [ "$TS" -lt "$THRESHOLD" ]; then
              echo "‚òÅÔ∏è  Job $NAME is stale! Last run was > 24h ago (TS: $TS)"
              exit 1
            fi

            echo "‚òÄÔ∏è $NAME passed all checks."
            
            echo "https://ci.ros2.org/job/$NAME/$BUILD/artifact/$REL_PATH" >> artifacts_urls.txt

          done <<< "$JOBS"
          # Pass urls to the GITHUB_OUTPUT 
          if [ -s artifacts_urls.txt ]; then
            URLS_ARRAY=$(cat artifacts_urls.txt | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "urls=$URLS_ARRAY" >> "$GITHUB_OUTPUT"
          else
            # If no urls are present fail
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
  download-artifacts:
    name: Download artifacts
    if: github.repository == 'ros2/ros2' && needs.verify-release-nightlies.outputs.should_update == 'true'
    runs-on: ubuntu-latest
    permissions: {}
    needs: verify-release-nightlies
    strategy:
      fail-fast: false
      matrix:
        target_url: ${{ fromJSON(needs.verify-release-nightlies.outputs.artifact_urls) }}
    steps:
      - name: Download artifacts
        run: | 
            echo "‚¨áÔ∏è Downloading artifacts for ${MATRIX_TARGET_URL}" 
            JOB_NAME=$(echo "${MATRIX_TARGET_URL}" | cut -d'/' -f5)
            OS=$(echo "$JOB_NAME" | sed 's/packaging_//; s/-aarch64//')

            if [[ "$JOB_NAME" == *"aarch64"* ]]; then 
              ARCH="arm64"
            else
              ARCH="amd64"
            fi 

            if [[ "$JOB_NAME" == *"windows"* ]]; then 
              EXT="zip"
            else
              EXT="tar.bz2"
            fi 
            ARTIFACT_NAME=ros2-rolling-nightly-$OS-$ARCH.$EXT
            echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
            curl  -H "Authorization: Bearer $GH_TOKEN" --retry 3 --retry-delay 5 --silent --globoff  "${MATRIX_TARGET_URL}" -o "$ARTIFACT_NAME"
            # Check if file is empty
            if [ ! -s "$ARTIFACT_NAME" ]; then
                echo "ERROR: Downloaded file $ARTIFACT_NAME is empty!"
                exit 1
            fi

            # Check if compression matches the extension
            FILE_TYPE=$(file -b "$ARTIFACT_NAME")

            case "$EXT" in
                zip)
                    [[ "$FILE_TYPE" == *"Zip archive data"* ]] || { echo "Format mismatch: Expected Zip"; exit 1; }
                    ;;
                tar.bz2)
                    [[ "$FILE_TYPE" == *"bzip2 compressed data"* ]] || { echo "Format mismatch: Expected Bzip2"; exit 1; }
                    ;;
                *)
                    echo "Warning: No specific validation for extension .$EXT."
                    exit 1
                    ;;
            esac

            echo "Validation successful: $ARTIFACT_NAME is not empty and matches $EXT format."
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          MATRIX_TARGET_URL: ${{ matrix.target_url }}
      - name: Upload artifacts to GH workflow storage
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with: 
          retention-days: 1
          name: ${{env.ARTIFACT_NAME}} 
          path: ${{env.ARTIFACT_NAME}} 
  update-release: 
    name: Update GH release
    if: github.repository == 'ros2/ros2' && needs.verify-release-nightlies.outputs.should_update == 'true'
    runs-on: ubuntu-latest
    needs: download-artifacts
    permissions:
      contents: write # Required to create the GitHub Release and upload assets
    steps:
      - name: Download artifacts 
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          # This downloads every artifact uploaded in the previous matrix
          path: ./artifacts
          pattern: ros2-rolling-*
          merge-multiple: true
      - name: Create release-notes file
        run: | 
          DATE=$(date +%Y-%m-%d)
          cat <<EOF > release-notes.md
          These are the binary packages for ROS 2 Rolling Nightlies $DATE.
          These binaries will get updated nightly given that all jobs have "not failed" to keep synchrony across operating systems.

          For runtime dependencies, see the binary package [installation instructions](https://docs.ros.org/en/rolling/Installation.html#binary-packages).
          Your system must be up-to-date to be compatible with the downloaded packages.

          Note: ignore the source code links because they don't contain the source code for ROS 2 (they're auto-generated by GitHub). Instead, grab the binary package for your platform. If you're interested in building from source, consult the [building from source instructions](https://docs.ros.org/en/rolling/Installation.html#building-from-source).
          EOF
          cat ./release-notes.md
      - name: Update artifacts in release
        run: |
          : # Check if the release exists. If not, create it.
          if ! gh release view  --repo "$GH_REPO" "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG not found. Creating new pre-release..."
            : # The target specified here is an orphaned branch to have something to point to.
            gh release create "$TAG" --repo "$GH_REPO"  --target "ros2ci-nightlies" --prerelease --title "ROS 2 Rolling - Nightlies $(date +%Y-%m-%d)" --notes-file ./release-notes.md 
          else
            echo "Release $TAG exists. Updating date and uploading."
            gh release edit "$TAG" --repo "$GH_REPO" --target "ros2ci-nightlies" --title "ROS 2 Rolling - Nightlies $(date +%Y-%m-%d)" --notes-file ./release-notes.md  --prerelease
          fi
          : # Verify artifacts exist and upload
          if [ -d "artifacts" ] && [ "$(ls -A artifacts)" ]; then
            gh release upload --repo "$GH_REPO"  "$TAG" artifacts/* --clobber
            echo "üöÄ Artifacts updated correctly"
          else
            echo "‚ùå No artifacts found to upload!"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}
